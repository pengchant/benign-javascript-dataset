(function(){var qboot=window.qboot;var tmpl=window.R.tmpl;var $id=window.hao360.g;var CUBE_BACKUP_DATA=window.CUBE_BACKUP_DATA;var cubeTpl=$id('cube-tpl').innerText;var cubeMods={};var appData=new AppData('api.hao.360.cn');window.cubePkgMap={};var cubesToBeLoad=[];function addCube(domId,data){if(!window.CubeSys){cubesToBeLoad.push({domId:domId,data:data});}}addCube.cubesToBeLoad=cubesToBeLoad;function CubeList(name){this.name=name||'recommend';this.$wrap=$id('cube-list-'+this.name);this.list=[];this._cubePos={};this.showingCube=[];this.p=1;this.fe_bp=0;qboot.createEvents(this);};CubeList.loadCube=(function(){var list=[];var resHost='https://s1.ssl.qhres.com/ssl/';return function(res){if(typeof res=='string'){res=[res];}if(hao360.http2Support){qboot.load(resHost+res.join(',')+'.js');}else{list=list.concat(res);setTimeout(function(){if(list.length){qboot.load(resHost+list.join(',')+'.js');list=[];}});}}})();CubeList.cubeMods=cubeMods;CubeList.cubeLists={};CubeList.getCubeById=function(id,name){name=name||'recommend';var cubeList=CubeList.cubeLists[name];var pos=cubeList._cubePos[id];return cubeList.list[pos];};qboot.mix(CubeList.prototype,{Browser:(function(){var na=window.navigator,ua=na.userAgent.toLowerCase(),browserTester=/(msie|webkit|gecko|presto|opera|safari|firefox|chrome|maxthon|android|ipad|iphone|webos|hpwos|trident)[ \/os]*([\d_.]+)/ig,Browser={platform:na.platform};ua.replace(browserTester,function(a,b,c){if(!Browser[b]){Browser[b]=c;}});if(!Browser.msie&&Browser.trident){ua.replace(/trident\/[0-9].*rv[ :]([0-9.]+)/ig,function(a,c){Browser.msie=c;});}if(Browser.msie){Browser.ie=Browser.msie;var v=parseInt(Browser.msie,10);Browser['ie'+v]=true;}return Browser;}()),loadCubedata:function(callback){if(window.CUBE_LIST_OPERA){this.fe_bp=1;this.formatData(window.CUBE_LIST_OPERA);callback&&callback(window.CUBE_LIST_OPERA);return;};var self=this,url='',getSearch=function(key){return hao360.queryUrl(location.search)[key];},cubeUrlConfig={m:hao360.mid,g:qboot.cookie.get('__guid'),h:qboot.cookie.get('__huid'),hsid:qboot.cookie.get('__hsid'),citycode:hao360.cityCode.get(),size:6,p:self.p,miniapp_only:hao360.mp360Support?1:0,iever:this.Browser.ie&&parseInt(this.Browser.ie,10),abid:getSearch('abid'),call_chain:getSearch('call_chain')},protocol=hao360.isHttp()?'http':'https',cubeJsonpConf={jsonp:'callback',timeout:5000,threshold:1};if((getSearch('cube_ids')||getSearch('pkg_ids'))&&!getSearch('mid')){var config={pkg_ids:getSearch('pkg_ids'),cube_ids:getSearch('cube_ids'),exts:getSearch('cube_ext'),content_ids:getSearch('content_ids'),tmprtps:getSearch('tmprtps'),miniapp_only:hao360.mp360Support?1:0,iever:this.Browser.ie&&parseInt(this.Browser.ie,10),online:getSearch('online')==1?1:undefined};url='https://cube-devtools.nav.qihoo.net/preview?'+qboot.encodeURIJson(config);}else{url='https://cube.dhrest.com/list?'+qboot.encodeURIJson(cubeUrlConfig);}qboot.jsonp(url,function(res){if(res&&res.errno===0){self.p++;}if(!res||res.errno===1){if(!res){window.cubeMonitor&&window.cubeMonitor.cubeTimeout(url)}res=CUBE_BACKUP_DATA;self.fe_bp=1;LogHub&&LogHub.behavior('cube','cubelist-timeout');}self.formatData(res);callback&&callback(res);},cubeJsonpConf);},formatData:function(res){if(res&&res.data&&res.data.list){var list=res.data.list,log_id=res.data.log_id,sign=res.data.sign;for(var i=0,l=list.length;i<l;i++){var cubeItem=list[i];cubeItem.log_id=log_id;cubeItem.sign=sign;cubeItem.queue_type=this.name;this.addCubeContainer(cubeItem);};};},addCubeContainer:function(data){var localData=appData.get('cube'+this.name),bkimg='';if(this.getPos(data.id)>=-1){return;}var id=data.id,expand_tpl=['<span class="cube-opera-split">|</span>','<a href="javascript:void(0);" class="cube-collapse-btn cube-btn" id="cube-collapse-'+data.id+'" cube-id="'+data.id+'">收起</a>','<a href="javascript:void(0);" class="cube-expand-btn cube-btn" id="cube-expand-'+data.id+'" cube-id="'+data.id+'">展开</a>'].join('');var cubeInfo=null;if(data!==null&&typeof data==="object"){cubeInfo={aid:data.aid,disable_expand:data.disable_expand,ext:data.ext,id:data.id,idn:data.idn,name:data.name,pkg_id:data.pkg_id,splash:data.splash,v:data.v,content_id:data.content_id,ticket:data.ticket,tmprtp:data.tmprtp}}cubeMods[id]=cubeMods[id]||cubeInfo;data.pos=this.list.length;data.status='hide';data.expanded=!data.disable_expand&&localData&&localData[id]&&localData[id].expanded?true:false;this.list.push(data);this._cubePos[id]=data.pos;var elId='cube-mod-'+this.name+'-'+id;var $box=document.createElement('div');if(!data.disable_expand&&localData&&localData[id]&&localData[id].expanded){$box.setAttribute('class','cube-mod cube-expand');bkimg=hao360.clipImage(data.splash,{whq:'368_255_75',webp:true});}else{$box.setAttribute('class','cube-mod');bkimg=hao360.clipImage(data.splash,{whq:'368_155_75',webp:true});}$box.setAttribute('id',elId);var tpldata={name:data.name,id:data.id,pkg_id:data.pkg_id,noexpand_class:data.disable_expand?'cube-noexpand':'',expand_tpl:data.disable_expand?'':expand_tpl,};$box.innerHTML=tmpl(cubeTpl,tpldata);$box.getElementsByClassName('cube-bd')[0].style.cssText='background: url('+bkimg+') top 8px center no-repeat;';this.$wrap.appendChild($box);CubeList.loadCube(data.res);window.cubePkgMap[data.pkg_id]=id;this.fire('cube:added',{cubeId:id});},removeCube:function(id){var cubePos=this._cubePos[id],self=this;var $el=this.getCubeMod(id);if($el){this.$wrap.removeChild($el);delete cubeMods[id];this.list.splice(cubePos,1);for(var i=cubePos,l=this.list.length;i<l;i++){this.list[i].pos--;}this._cubePos[id]=-1;this.list.forEach(function(item){self._cubePos[item.id]=item.pos;});this.fire('cube:removed',{cubeId:id});}},getPos:function(id){return this._cubePos[id];},getCubeMod:function(id){var elId='cube-mod-'+this.name+'-'+id;return $id(elId);}});CubeList.cubeLists['recommend']=new CubeList('recommend');window.CubeList=CubeList;window.addCube=addCube;})();