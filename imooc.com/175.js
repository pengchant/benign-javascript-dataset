
var isLogin=0
var _hmt = _hmt || [];
var pageInfo = {
	canForward:"1",
    id: "255063",
    praiseNum:"0"
}
var dtid = "253610";
var marking = "clouddata";
var user = {
    uid : ''
}
var authorUid = {
    uid : '6798203'
}
var curPage = 'details'

var a_id = 255063

// 为html转码，article_content 为新markdown编辑器接收的初始化内容
var article_content = "&lt;p&gt;我的原创地址：&lt;a href=&quot;https://dongkelun.com/2018/08/02/sparkUDF/&quot;&gt;https://dongkelun.com/2018/08/02/sparkUDF/&lt;/a&gt;&lt;/p&gt;&lt;h2&gt;前言&lt;/h2&gt;&lt;p&gt;本文介绍如何在Spark Sql和DataFrame中使用UDF，如何利用UDF给一个表或者一个DataFrame根据需求添加几列，并给出了旧版（Spark1.x）和新版（Spark2.x）完整的代码示例。&lt;/p&gt;&lt;ul class=&quot; list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;关于UDF：UDF：User Defined Function，用户自定义函数。&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2&gt;1、创建测试用DataFrame&lt;/h2&gt;&lt;p&gt;下面以Spark2.x为例给出代码，关于Spark1.x创建DataFrame可在最后的完整代码里查看。&lt;/p&gt;&lt;pre&gt;//&amp;nbsp;构造测试数据，有两个字段、名字和年龄val&amp;nbsp;userData&amp;nbsp;=&amp;nbsp;Array((&amp;quot;Leo&amp;quot;,&amp;nbsp;16),&amp;nbsp;(&amp;quot;Marry&amp;quot;,&amp;nbsp;21),&amp;nbsp;(&amp;quot;Jack&amp;quot;,&amp;nbsp;14),&amp;nbsp;(&amp;quot;Tom&amp;quot;,&amp;nbsp;18))//创建测试dfval&amp;nbsp;userDF&amp;nbsp;=&amp;nbsp;spark.createDataFrame(userData).toDF(&amp;quot;name&amp;quot;,&amp;nbsp;&amp;quot;age&amp;quot;)\nuserDF.show&lt;/pre&gt;&lt;pre&gt;+-----+---+\n|&amp;nbsp;name|age|\n+-----+---+\n|&amp;nbsp;&amp;nbsp;Leo|&amp;nbsp;16|\n|Marry|&amp;nbsp;21|\n|&amp;nbsp;Jack|&amp;nbsp;14|\n|&amp;nbsp;&amp;nbsp;Tom|&amp;nbsp;18|\n+-----+---+&lt;/pre&gt;&lt;pre&gt;//&amp;nbsp;注册一张user表userDF.createOrReplaceTempView(&amp;quot;user&amp;quot;)&lt;/pre&gt;&lt;h2&gt;2、Spark Sql用法&lt;/h2&gt;&lt;h3&gt;2.1 通过匿名函数注册UDF&lt;/h3&gt;&lt;p&gt;下面的UDF的功能是计算某列的长度，该列的类型为String&lt;/p&gt;&lt;h4&gt;2.1.1 注册&lt;/h4&gt;&lt;ul class=&quot; list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;Spark2.x:&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;pre&gt;spark.udf.register(&amp;quot;strLen&amp;quot;,&amp;nbsp;(str:&amp;nbsp;String)&amp;nbsp;=&amp;gt;&amp;nbsp;str.length())&lt;/pre&gt;&lt;ul class=&quot; list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;Spark1.x:&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;pre&gt;sqlContext.udf.register(&amp;quot;strLen&amp;quot;,&amp;nbsp;(str:&amp;nbsp;String)&amp;nbsp;=&amp;gt;&amp;nbsp;str.length())&lt;/pre&gt;&lt;h4&gt;2.2.2 使用&lt;/h4&gt;&lt;p&gt;仅以Spark2.x为例&lt;/p&gt;&lt;pre&gt;spark.sql(&amp;quot;select&amp;nbsp;name,strLen(name)&amp;nbsp;as&amp;nbsp;name_len&amp;nbsp;from&amp;nbsp;user&amp;quot;).show&lt;/pre&gt;&lt;pre&gt;+-----+--------+\n|&amp;nbsp;name|name_len|\n+-----+--------+\n|&amp;nbsp;&amp;nbsp;Leo|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;3|\n|Marry|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;5|\n|&amp;nbsp;Jack|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;4|\n|&amp;nbsp;&amp;nbsp;Tom|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;3|\n+-----+--------+&lt;/pre&gt;&lt;h3&gt;2.2 通过实名函数注册UDF&lt;/h3&gt;&lt;p&gt;实名函数的注册有点不同，要在后面加 _(注意前面有个空格)&lt;br/&gt;定义一个实名函数&lt;/p&gt;&lt;pre&gt;/**\n&amp;nbsp;*&amp;nbsp;根据年龄大小返回是否成年&amp;nbsp;成年：true,未成年：false\n*/def&amp;nbsp;isAdult(age:&amp;nbsp;Int)&amp;nbsp;=&amp;nbsp;{&amp;nbsp;&amp;nbsp;if&amp;nbsp;(age&amp;nbsp;&amp;lt;&amp;nbsp;18)&amp;nbsp;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;false\n&amp;nbsp;&amp;nbsp;}&amp;nbsp;else&amp;nbsp;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;true\n&amp;nbsp;&amp;nbsp;}\n\n}&lt;/pre&gt;&lt;p&gt;注册（仅以Spark2.x为例）&lt;/p&gt;&lt;pre&gt;spark.udf.register(&amp;quot;isAdult&amp;quot;,&amp;nbsp;isAdult&amp;nbsp;_)&lt;/pre&gt;&lt;p&gt;至于使用都是一样的&lt;/p&gt;&lt;h3&gt;2.3 关于spark.udf和sqlContext.udf&lt;/h3&gt;&lt;p&gt;在Spark2.x里，两者实际最终都是调用的spark.udf&lt;br/&gt;sqlContext.udf源码&lt;/p&gt;&lt;pre&gt;def&amp;nbsp;udf:&amp;nbsp;UDFRegistration&amp;nbsp;=&amp;nbsp;sparkSession.udf&lt;/pre&gt;&lt;p&gt;可以看到调用的是sparkSession的udf，即spark.udf&lt;/p&gt;&lt;h2&gt;3、DataFrame用法&lt;/h2&gt;&lt;p&gt;DataFrame的udf方法虽然和Spark Sql的名字一样，但是属于不同的类，它在org.apache.spark.sql.functions里，下面是它的用法&lt;/p&gt;&lt;h3&gt;3.1注册&lt;/h3&gt;&lt;pre&gt;import&amp;nbsp;org.apache.spark.sql.functions._//注册自定义函数（通过匿名函数）val&amp;nbsp;strLen&amp;nbsp;=&amp;nbsp;udf((str:&amp;nbsp;String)&amp;nbsp;=&amp;gt;&amp;nbsp;str.length())//注册自定义函数（通过实名函数）val&amp;nbsp;udf_isAdult&amp;nbsp;=&amp;nbsp;udf(isAdult&amp;nbsp;_)&lt;/pre&gt;&lt;h3&gt;3.2 使用&lt;/h3&gt;&lt;p&gt;可通过withColumn和select使用,下面的代码已经实现了给user表添加两列的功能&lt;/p&gt;&lt;ul class=&quot; list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;通过看源码，下面的withColumn和select方法Spark2.0.0之后才有的，关于spark1.xDataFrame怎么使用注册好的UDF没有研究&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;pre&gt;//通过withColumn添加列userDF.withColumn(&amp;quot;name_len&amp;quot;,&amp;nbsp;strLen(col(&amp;quot;name&amp;quot;))).withColumn(&amp;quot;isAdult&amp;quot;,&amp;nbsp;udf_isAdult(col(&amp;quot;age&amp;quot;))).show//通过select添加列userDF.select(col(&amp;quot;*&amp;quot;),&amp;nbsp;strLen(col(&amp;quot;name&amp;quot;))&amp;nbsp;as&amp;nbsp;&amp;quot;name_len&amp;quot;,&amp;nbsp;udf_isAdult(col(&amp;quot;age&amp;quot;))&amp;nbsp;as&amp;nbsp;&amp;quot;isAdult&amp;quot;).show&lt;/pre&gt;&lt;p&gt;结果均为&lt;/p&gt;&lt;pre&gt;+-----+---+--------+-------+\n|&amp;nbsp;name|age|name_len|isAdult|\n+-----+---+--------+-------+\n|&amp;nbsp;&amp;nbsp;Leo|&amp;nbsp;16|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;3|&amp;nbsp;&amp;nbsp;false|\n|Marry|&amp;nbsp;21|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;5|&amp;nbsp;&amp;nbsp;&amp;nbsp;true|\n|&amp;nbsp;Jack|&amp;nbsp;14|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;4|&amp;nbsp;&amp;nbsp;false|\n|&amp;nbsp;&amp;nbsp;Tom|&amp;nbsp;18|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;3|&amp;nbsp;&amp;nbsp;&amp;nbsp;true|\n+-----+---+--------+-------+&lt;/pre&gt;&lt;h3&gt;3.3 withColumn和select的区别&lt;/h3&gt;&lt;p&gt;可通过withColumn的源码看出withColumn的功能是实现增加一列，或者替换一个已存在的列，他会先判断DataFrame里有没有这个列名，如果有的话就会替换掉原来的列，没有的话就用调用select方法增加一列，所以如果我们的需求是增加一列的话，两者实现的功能一样，且最终都是调用select方法，但是withColumn会提前做一些判断处理，所以withColumn的性能不如select好。&lt;/p&gt;&lt;ul class=&quot; list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;注：select方法和sql 里的select一样，如果新增的列名在表里已经存在，那么结果里允许出现两列列名相同但数据不一样，大家可以自己试一下。&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;pre&gt;/**\n&amp;nbsp;*&amp;nbsp;Returns&amp;nbsp;a&amp;nbsp;new&amp;nbsp;Dataset&amp;nbsp;by&amp;nbsp;adding&amp;nbsp;a&amp;nbsp;column&amp;nbsp;or&amp;nbsp;replacing&amp;nbsp;the&amp;nbsp;existing&amp;nbsp;column&amp;nbsp;that&amp;nbsp;has\n&amp;nbsp;*&amp;nbsp;the&amp;nbsp;same&amp;nbsp;name.\n&amp;nbsp;*\n&amp;nbsp;*&amp;nbsp;@group&amp;nbsp;untypedrel\n&amp;nbsp;*&amp;nbsp;@since&amp;nbsp;2.0.0\n*/def&amp;nbsp;withColumn(colName:&amp;nbsp;String,&amp;nbsp;col:&amp;nbsp;Column):&amp;nbsp;DataFrame&amp;nbsp;=&amp;nbsp;{&amp;nbsp;&amp;nbsp;val&amp;nbsp;resolver&amp;nbsp;=&amp;nbsp;sparkSession.sessionState.analyzer.resolver&amp;nbsp;&amp;nbsp;val&amp;nbsp;output&amp;nbsp;=&amp;nbsp;queryExecution.analyzed.output&amp;nbsp;&amp;nbsp;val&amp;nbsp;shouldReplace&amp;nbsp;=&amp;nbsp;output.exists(f&amp;nbsp;=&amp;gt;&amp;nbsp;resolver(f.name,&amp;nbsp;colName))&amp;nbsp;&amp;nbsp;if&amp;nbsp;(shouldReplace)&amp;nbsp;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;columns&amp;nbsp;=&amp;nbsp;output.map&amp;nbsp;{&amp;nbsp;field&amp;nbsp;=&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if&amp;nbsp;(resolver(field.name,&amp;nbsp;colName))&amp;nbsp;{\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;col.as(colName)\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&amp;nbsp;else&amp;nbsp;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Column(field)\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;select(columns&amp;nbsp;:&amp;nbsp;_*)\n&amp;nbsp;&amp;nbsp;}&amp;nbsp;else&amp;nbsp;{\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;select(Column(&amp;quot;*&amp;quot;),&amp;nbsp;col.as(colName))\n&amp;nbsp;&amp;nbsp;}\n}&lt;/pre&gt;&lt;h2&gt;4、完整代码&lt;/h2&gt;&lt;p&gt;下面的代码的功能是使用UDF给user表添加两列:name_len、isAdult，每个输出结果都是一样的&lt;/p&gt;&lt;pre&gt;+-----+---+--------+-------+\n|&amp;nbsp;name|age|name_len|isAdult|\n+-----+---+--------+-------+\n|&amp;nbsp;&amp;nbsp;Leo|&amp;nbsp;16|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;3|&amp;nbsp;&amp;nbsp;false|\n|Marry|&amp;nbsp;21|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;5|&amp;nbsp;&amp;nbsp;&amp;nbsp;true|\n|&amp;nbsp;Jack|&amp;nbsp;14|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;4|&amp;nbsp;&amp;nbsp;false|\n|&amp;nbsp;&amp;nbsp;Tom|&amp;nbsp;18|&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;3|&amp;nbsp;&amp;nbsp;&amp;nbsp;true|\n+-----+---+--------+-------+&lt;/pre&gt;&lt;p&gt;代码：&lt;/p&gt;&lt;pre&gt;package&amp;nbsp;com.dkl.leanring.spark.sqlimport&amp;nbsp;org.apache.spark.SparkContextimport&amp;nbsp;org.apache.spark.sql.SQLContextimport&amp;nbsp;org.apache.spark.SparkConfimport&amp;nbsp;org.apache.spark.sql.SparkSession/**\n&amp;nbsp;*&amp;nbsp;Spark&amp;nbsp;Sql&amp;nbsp;用户自定义函数示例\n&amp;nbsp;*/object&amp;nbsp;UdfDemo&amp;nbsp;{&amp;nbsp;&amp;nbsp;def&amp;nbsp;main(args:&amp;nbsp;Array[String]):&amp;nbsp;Unit&amp;nbsp;=&amp;nbsp;{\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;oldUdf\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;newUdf\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;newDfUdf\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;oldDfUdf\n&amp;nbsp;&amp;nbsp;}&amp;nbsp;&amp;nbsp;/**\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*&amp;nbsp;根据年龄大小返回是否成年&amp;nbsp;成年：true,未成年：false\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*/\n&amp;nbsp;&amp;nbsp;def&amp;nbsp;isAdult(age:&amp;nbsp;Int)&amp;nbsp;=&amp;nbsp;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if&amp;nbsp;(age&amp;nbsp;&amp;lt;&amp;nbsp;18)&amp;nbsp;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;false\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&amp;nbsp;else&amp;nbsp;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;true\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}\n\n&amp;nbsp;&amp;nbsp;}&amp;nbsp;&amp;nbsp;/**\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*&amp;nbsp;旧版本(Spark1.x)Spark&amp;nbsp;Sql&amp;nbsp;udf示例\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*/\n&amp;nbsp;&amp;nbsp;def&amp;nbsp;oldUdf()&amp;nbsp;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//spark&amp;nbsp;初始化\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;conf&amp;nbsp;=&amp;nbsp;new&amp;nbsp;SparkConf()\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.setMaster(&amp;quot;local&amp;quot;)\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.setAppName(&amp;quot;oldUdf&amp;quot;)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;sc&amp;nbsp;=&amp;nbsp;new&amp;nbsp;SparkContext(conf)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;sqlContext&amp;nbsp;=&amp;nbsp;new&amp;nbsp;SQLContext(sc)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;import&amp;nbsp;sqlContext.implicits._&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//&amp;nbsp;构造测试数据，有两个字段、名字和年龄\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;userData&amp;nbsp;=&amp;nbsp;Array((&amp;quot;Leo&amp;quot;,&amp;nbsp;16),&amp;nbsp;(&amp;quot;Marry&amp;quot;,&amp;nbsp;21),&amp;nbsp;(&amp;quot;Jack&amp;quot;,&amp;nbsp;14),&amp;nbsp;(&amp;quot;Tom&amp;quot;,&amp;nbsp;18))&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//创建测试df\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;userDF&amp;nbsp;=&amp;nbsp;sc.parallelize(userData).toDF(&amp;quot;name&amp;quot;,&amp;nbsp;&amp;quot;age&amp;quot;)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//&amp;nbsp;注册一张user表\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;userDF.registerTempTable(&amp;quot;user&amp;quot;)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//&amp;nbsp;注册自定义函数（通过匿名函数）\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sqlContext.udf.register(&amp;quot;strLen&amp;quot;,&amp;nbsp;(str:&amp;nbsp;String)&amp;nbsp;=&amp;gt;&amp;nbsp;str.length())\n\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sqlContext.udf.register(&amp;quot;isAdult&amp;quot;,&amp;nbsp;isAdult&amp;nbsp;_)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//&amp;nbsp;使用自定义函数\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sqlContext.sql(&amp;quot;select&amp;nbsp;*,strLen(name)as&amp;nbsp;name_len,isAdult(age)&amp;nbsp;as&amp;nbsp;isAdult&amp;nbsp;from&amp;nbsp;user&amp;quot;).show&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//关闭\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sc.stop()\n\n&amp;nbsp;&amp;nbsp;}&amp;nbsp;&amp;nbsp;/**\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*&amp;nbsp;新版本(Spark2.x)Spark&amp;nbsp;Sql&amp;nbsp;udf示例\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*/\n&amp;nbsp;&amp;nbsp;def&amp;nbsp;newUdf()&amp;nbsp;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//spark初始化\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;spark&amp;nbsp;=&amp;nbsp;SparkSession.builder().appName(&amp;quot;newUdf&amp;quot;).master(&amp;quot;local&amp;quot;).getOrCreate()&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//&amp;nbsp;构造测试数据，有两个字段、名字和年龄\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;userData&amp;nbsp;=&amp;nbsp;Array((&amp;quot;Leo&amp;quot;,&amp;nbsp;16),&amp;nbsp;(&amp;quot;Marry&amp;quot;,&amp;nbsp;21),&amp;nbsp;(&amp;quot;Jack&amp;quot;,&amp;nbsp;14),&amp;nbsp;(&amp;quot;Tom&amp;quot;,&amp;nbsp;18))&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//创建测试df\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;userDF&amp;nbsp;=&amp;nbsp;spark.createDataFrame(userData).toDF(&amp;quot;name&amp;quot;,&amp;nbsp;&amp;quot;age&amp;quot;)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//&amp;nbsp;注册一张user表\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;userDF.createOrReplaceTempView(&amp;quot;user&amp;quot;)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//注册自定义函数（通过匿名函数）\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;spark.udf.register(&amp;quot;strLen&amp;quot;,&amp;nbsp;(str:&amp;nbsp;String)&amp;nbsp;=&amp;gt;&amp;nbsp;str.length())&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//注册自定义函数（通过实名函数）\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;spark.udf.register(&amp;quot;isAdult&amp;quot;,&amp;nbsp;isAdult&amp;nbsp;_)\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;spark.sql(&amp;quot;select&amp;nbsp;*,strLen(name)&amp;nbsp;as&amp;nbsp;name_len,isAdult(age)&amp;nbsp;as&amp;nbsp;isAdult&amp;nbsp;from&amp;nbsp;user&amp;quot;).show&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//关闭\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;spark.stop()\n\n&amp;nbsp;&amp;nbsp;}&amp;nbsp;&amp;nbsp;/**\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*&amp;nbsp;新版本(Spark2.x)DataFrame&amp;nbsp;udf示例\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*/\n&amp;nbsp;&amp;nbsp;def&amp;nbsp;newDfUdf()&amp;nbsp;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;spark&amp;nbsp;=&amp;nbsp;SparkSession.builder().appName(&amp;quot;newDfUdf&amp;quot;).master(&amp;quot;local&amp;quot;).getOrCreate()&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//&amp;nbsp;构造测试数据，有两个字段、名字和年龄\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;userData&amp;nbsp;=&amp;nbsp;Array((&amp;quot;Leo&amp;quot;,&amp;nbsp;16),&amp;nbsp;(&amp;quot;Marry&amp;quot;,&amp;nbsp;21),&amp;nbsp;(&amp;quot;Jack&amp;quot;,&amp;nbsp;14),&amp;nbsp;(&amp;quot;Tom&amp;quot;,&amp;nbsp;18))&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//创建测试df\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;userDF&amp;nbsp;=&amp;nbsp;spark.createDataFrame(userData).toDF(&amp;quot;name&amp;quot;,&amp;nbsp;&amp;quot;age&amp;quot;)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;import&amp;nbsp;org.apache.spark.sql.functions._&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//注册自定义函数（通过匿名函数）\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;strLen&amp;nbsp;=&amp;nbsp;udf((str:&amp;nbsp;String)&amp;nbsp;=&amp;gt;&amp;nbsp;str.length())&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//注册自定义函数（通过实名函数）\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;udf_isAdult&amp;nbsp;=&amp;nbsp;udf(isAdult&amp;nbsp;_)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//通过withColumn添加列\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;userDF.withColumn(&amp;quot;name_len&amp;quot;,&amp;nbsp;strLen(col(&amp;quot;name&amp;quot;))).withColumn(&amp;quot;isAdult&amp;quot;,&amp;nbsp;udf_isAdult(col(&amp;quot;age&amp;quot;))).show&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//通过select添加列\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;userDF.select(col(&amp;quot;*&amp;quot;),&amp;nbsp;strLen(col(&amp;quot;name&amp;quot;))&amp;nbsp;as&amp;nbsp;&amp;quot;name_len&amp;quot;,&amp;nbsp;udf_isAdult(col(&amp;quot;age&amp;quot;))&amp;nbsp;as&amp;nbsp;&amp;quot;isAdult&amp;quot;).show&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//关闭\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;spark.stop()\n&amp;nbsp;&amp;nbsp;}&amp;nbsp;&amp;nbsp;/**\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*&amp;nbsp;旧版本(Spark1.x)DataFrame&amp;nbsp;udf示例\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*&amp;nbsp;注意，这里只是用的Spark1.x创建sc的和df的语法，其中注册udf在Spark1.x也是可以使用的的\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*&amp;nbsp;但是withColumn和select方法Spark2.0.0之后才有的，关于spark1.xDataFrame怎么使用注册好的UDF没有研究\n&amp;nbsp;&amp;nbsp;&amp;nbsp;*/\n&amp;nbsp;&amp;nbsp;def&amp;nbsp;oldDfUdf()&amp;nbsp;{&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//spark&amp;nbsp;初始化\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;conf&amp;nbsp;=&amp;nbsp;new&amp;nbsp;SparkConf()\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.setMaster(&amp;quot;local&amp;quot;)\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.setAppName(&amp;quot;oldDfUdf&amp;quot;)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;sc&amp;nbsp;=&amp;nbsp;new&amp;nbsp;SparkContext(conf)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;sqlContext&amp;nbsp;=&amp;nbsp;new&amp;nbsp;SQLContext(sc)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;import&amp;nbsp;sqlContext.implicits._&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//&amp;nbsp;构造测试数据，有两个字段、名字和年龄\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;userData&amp;nbsp;=&amp;nbsp;Array((&amp;quot;Leo&amp;quot;,&amp;nbsp;16),&amp;nbsp;(&amp;quot;Marry&amp;quot;,&amp;nbsp;21),&amp;nbsp;(&amp;quot;Jack&amp;quot;,&amp;nbsp;14),&amp;nbsp;(&amp;quot;Tom&amp;quot;,&amp;nbsp;18))&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//创建测试df\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;userDF&amp;nbsp;=&amp;nbsp;sc.parallelize(userData).toDF(&amp;quot;name&amp;quot;,&amp;nbsp;&amp;quot;age&amp;quot;)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;import&amp;nbsp;org.apache.spark.sql.functions._&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//注册自定义函数（通过匿名函数）\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;strLen&amp;nbsp;=&amp;nbsp;udf((str:&amp;nbsp;String)&amp;nbsp;=&amp;gt;&amp;nbsp;str.length())&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//注册自定义函数（通过实名函数）\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;val&amp;nbsp;udf_isAdult&amp;nbsp;=&amp;nbsp;udf(isAdult&amp;nbsp;_)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//通过withColumn添加列\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;userDF.withColumn(&amp;quot;name_len&amp;quot;,&amp;nbsp;strLen(col(&amp;quot;name&amp;quot;))).withColumn(&amp;quot;isAdult&amp;quot;,&amp;nbsp;udf_isAdult(col(&amp;quot;age&amp;quot;))).show&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//通过select添加列\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;userDF.select(col(&amp;quot;*&amp;quot;),&amp;nbsp;strLen(col(&amp;quot;name&amp;quot;))&amp;nbsp;as&amp;nbsp;&amp;quot;name_len&amp;quot;,&amp;nbsp;udf_isAdult(col(&amp;quot;age&amp;quot;))&amp;nbsp;as&amp;nbsp;&amp;quot;isAdult&amp;quot;).show&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;//关闭\n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sc.stop()\n&amp;nbsp;&amp;nbsp;}\n\n}&lt;/pre&gt;&lt;p&gt;&lt;img data-original-src=&quot;//upload-images.jianshu.io/upload_images/12267859-d908c39ff9f9d93f.jpg&quot; data-original-width=&quot;1510&quot; data-original-height=&quot;920&quot; data-original-format=&quot;image/jpeg&quot; data-original-filesize=&quot;634617&quot; class=&quot;&quot; style=&quot;cursor: zoom-in;&quot; src=&quot;//upload-images.jianshu.io/upload_images/12267859-d908c39ff9f9d93f.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp&quot;/&gt;&lt;/p&gt;&lt;p&gt;image&lt;/p&gt;&lt;p&gt;&lt;!-- 如果是付费文章，未购买，则显示购买按钮 --&gt;\n\n &amp;nbsp; &amp;nbsp;&lt;!-- 连载目录项 --&gt;\n\n &amp;nbsp; &amp;nbsp;&lt;!-- 如果是付费文章 --&gt;\n &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;!-- 如果是付费连载，已购买，且作者允许赞赏，则显示付费信息和赞赏 --&gt;&lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;br/&gt;作者：董可伦&lt;br/&gt;链接：https://www.jianshu.com/p/bded081b5350&lt;br/&gt;&lt;br/&gt;&lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;/p&gt;";
// 为html反转码
article_content = article_content.replace(/\&lt\;/g, "<").replace(/\&gt\;/g, ">").replace(/\&amp\;/g, "&").replace(/\&quot\;/g, '"').replace(/\&apos\;/g, "'");
// 递归遍历dom，处理图片懒加载
function dfs(root) {
	var nodes = Array.prototype.slice.call(root.children);
	if (nodes.length) {
		nodes.forEach(function (node) {
			if(node.tagName == 'IMG') {
				var src = node.src;
				var alt = node.alt;
				var reg = /(?:imooc|mukewang)\.com\/[A-Za-z0-9]+?\.jpg$/;
				// ueditor 上传的图片，alt为原图高清
				if(reg.test(alt)) {
					!node.getAttribute('data-src') && node.setAttribute('data-src', alt);
					node.setAttribute('data-original', alt); // 直接显示原图
				} else {
					node.setAttribute('data-original', src);
				}
				node.setAttribute('class', 'lazyload');
				node.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC';
			}
			dfs(node);
		});
	}
}
// 创建手记内容dom节点
var articleEl = document.createElement("div");
articleEl.innerHTML = article_content;
// 遍历手记dom树
dfs(articleEl);
